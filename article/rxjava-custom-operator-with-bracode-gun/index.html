<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"><title>Rxjava自定义操作符与扫码枪 | Hey sister</title><meta name="description" content="Rxjava自定义操作符在扫码枪中的应用"><meta name="keywords" content="rxjava,android,barcode-gun"><meta name="author" content="qbeenslee"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><meta property="og:title" content="Rxjava自定义操作符与扫码枪 | Hey sister"><meta property="og:description" content="Rxjava自定义操作符在扫码枪中的应用"><meta property="og:url" content="https://qbeenslee.com/article/rxjava-custom-operator-with-bracode-gun/"><meta property="og:site_name" content="Hey sister"><meta property="og:type" content="article"><meta property="og:image" content="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2019/10/rxjavawithandroid.png"><meta property="article:published_time" content="2019-10-24T20:33:26&#43;08:00"><meta property="article:modified_time" content="2019-10-24T20:33:26&#43;08:00"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><link rel="alternate" type="application/rss+xml" title="Hey sister" href="https://qbeenslee.com/index.xml"><link rel="stylesheet" href="https://qbeenslee.com/css/main-9c3c5787dc.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" type="text/javascript"></script><script src="https://cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js" type="text/javascript"></script></head><body><link rel="stylesheet" href="https://qbeenslee.com/lib/photoswipe/photoswipe-9328c1ab81.min.css"><link rel="stylesheet" href="https://qbeenslee.com/lib/photoswipe/default-skin/default-skin-bbac268b9c.min.css"><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><header id="header" class="auto_header unselectable transHeader" style="top:0;position:fixed;z-index:9999"><div class="site"><a href="/"><div class="title">Hey sister</div></a></div><div id="nav-bar"><nav class="nav-item"> <a class="nav-color-normal" href="/bb/">小声BB</a></nav><nav class="nav-item dropdown"> <a class="dropbtn nav-color-normal">归档<span class="caret"></span></a><div class="dropdown-content"> <a href="/categories/">分类</a> <a href="/tags/">标签</a></div></nav><nav class="nav-item dropdown"> <a class="dropbtn nav-color-normal">关于<span class="caret"></span></a><div class="dropdown-content"> <a href="/about/">关于我</a> <a href="/friends/">友情链接</a> <a href="/website-building/">技术说明</a> <a href="/copyright/">版权声明</a> <a href="/index.xml">订阅</a></div></nav></div></header><main style="background-color:#fff"><div id="banner" class="banner normal"><div class="banner-wrapper"><img class="cover" data-original="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2019/10/rxjavawithandroid.png"></div></div><div id="page" class="vertical-safe-covered"><div class="page-wrap"><div class="middle-side horizontal-safe"><article><div class="article-header"><h1 class="title">RXJAVA自定义操作符与扫码枪</h1><span class="subtitle">本文创作于2019年10月24日 20:33</span></div><div class="content"><p>正是Rxjava丰富的操作符, 简化了我们的日常开发的工作量. 本文将介绍Rxjava自定义操作符在实际开发中的应用.</p><h2 id="操作符应用举例">操作符应用举例</h2><p>下面是一个使用例子:</p><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">//加购凑单逻辑
</span><span style="color:#60a0b0;font-style:italic"></span>fun <span style="color:#06287e">shoppingCartGoods</span><span style="color:#666">(</span>act<span style="color:#666">:</span> RaiseBuyActBO<span style="color:#666">,</span> goods<span style="color:#666">:</span> List<span style="color:#666">&lt;</span>ActivityGoodsBO<span style="color:#666">&gt;?,</span> limit<span style="color:#666">:</span> Int<span style="color:#666">)</span> <span style="color:#666">=</span> Observable
        <span style="color:#666">.</span><span style="color:#4070a0">just</span><span style="color:#666">(</span>goods<span style="color:#666">)</span>
        <span style="color:#666">.</span><span style="color:#4070a0">subscribeOn</span><span style="color:#666">(</span>Schedulers<span style="color:#666">.</span><span style="color:#4070a0">computation</span><span style="color:#666">())</span>
        <span style="color:#666">.</span><span style="color:#4070a0">observeOn</span><span style="color:#666">(</span>AndroidSchedulers<span style="color:#666">.</span><span style="color:#4070a0">mainThread</span><span style="color:#666">())</span>
        <span style="color:#666">.</span><span style="color:#4070a0">flatMapIterable</span> <span style="color:#666">{</span> it <span style="color:#666">}</span>
        <span style="color:#666">.</span><span style="color:#4070a0">filter</span> <span style="color:#666">{</span> MarketingLogic<span style="color:#666">.</span><span style="color:#4070a0">isActivityGoods</span><span style="color:#666">(</span>act<span style="color:#666">.</span><span style="color:#4070a0">rangeTypeIsAll</span><span style="color:#666">(),</span> act<span style="color:#666">.</span><span style="color:#4070a0">filterGoodsIds</span><span style="color:#666">(),</span> it<span style="color:#666">.</span><span style="color:#4070a0">goodsId</span><span style="color:#666">)</span> <span style="color:#666">}</span>
        <span style="color:#666">.</span><span style="color:#4070a0">distinct</span> <span style="color:#666">{</span> it<span style="color:#666">.</span><span style="color:#4070a0">goodsId</span> <span style="color:#666">}</span>
        <span style="color:#666">.</span><span style="color:#4070a0">take</span><span style="color:#666">(</span>limit<span style="color:#666">)</span>
        <span style="color:#666">.</span><span style="color:#4070a0">map</span> <span style="color:#666">{</span> it<span style="color:#666">.</span><span style="color:#4070a0">goodsId</span> <span style="color:#666">}</span>
        <span style="color:#666">.</span><span style="color:#4070a0">toList</span><span style="color:#666">()</span>
        <span style="color:#666">.</span><span style="color:#4070a0">flatMap</span> <span style="color:#666">{</span> GoodsDao<span style="color:#666">.</span><span style="color:#4070a0">getGoodsById</span><span style="color:#666">(</span>it<span style="color:#666">)</span> <span style="color:#666">}</span>
        <span style="color:#666">.</span><span style="color:#4070a0">flatMapIterable</span> <span style="color:#666">{</span> it <span style="color:#666">}</span>
        <span style="color:#666">.</span><span style="color:#4070a0">take</span><span style="color:#666">(</span>limit<span style="color:#666">)</span>
        <span style="color:#666">.</span><span style="color:#4070a0">toList</span><span style="color:#666">()</span>
</code></pre></div><p></p><figure class="image-label"><img data-original="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2019/10/15719204523447.jpg" alt="Rxjava操作符大全"><figcaption>Rxjava操作符大全</figcaption></figure><p></p><h2 id="操作符的实现原理">操作符的实现原理</h2><blockquote><p>操作符是如何实现的, 它的调度流程是怎么样的?</p></blockquote><p>简化<a href="https://github.com/ReactiveX/RxJava/blob/1.x/src/main/java/rx/internal/operators/OnSubscribeLift.java" target="_blank"><code>OnSubscribeLift</code></a>只保留核心逻辑如下:</p><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#007020;font-weight:700">public</span> <span style="color:#666">&lt;</span>R<span style="color:#666">&gt;</span> Observable<span style="color:#666">&lt;</span>R<span style="color:#666">&gt;</span> <span style="color:#06287e">lift</span><span style="color:#666">(</span>Operator<span style="color:#666">&lt;?</span> <span style="color:#007020;font-weight:700">extends</span> R<span style="color:#666">,</span> <span style="color:#666">?</span> <span style="color:#007020;font-weight:700">super</span> T<span style="color:#666">&gt;</span> operator<span style="color:#666">)</span> <span style="color:#666">{</span>
    <span style="color:#007020;font-weight:700">return</span> Observable<span style="color:#666">.</span><span style="color:#4070a0">create</span><span style="color:#666">(</span><span style="color:#007020;font-weight:700">new</span> OnSubscribe<span style="color:#666">&lt;</span>R<span style="color:#666">&gt;()</span> <span style="color:#666">{</span>
        <span style="color:#555;font-weight:700">@Override</span>
        <span style="color:#007020;font-weight:700">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">call</span><span style="color:#666">(</span>Subscriber subscriber<span style="color:#666">)</span> <span style="color:#666">{</span>
            Subscriber newSubscriber <span style="color:#666">=</span> operator<span style="color:#666">.</span><span style="color:#4070a0">call</span><span style="color:#666">(</span>subscriber<span style="color:#666">);</span> <span style="color:#60a0b0;font-style:italic">//All starting with subscribe()
</span><span style="color:#60a0b0;font-style:italic"></span>            newSubscriber<span style="color:#666">.</span><span style="color:#4070a0">onStart</span><span style="color:#666">();</span> <span style="color:#60a0b0;font-style:italic">//Default do nothing 
</span><span style="color:#60a0b0;font-style:italic"></span>            onSubscribe<span style="color:#666">.</span><span style="color:#4070a0">call</span><span style="color:#666">(</span>newSubscriber<span style="color:#666">);</span> <span style="color:#60a0b0;font-style:italic">//Observable.this.onSubscribe
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#666">}</span>
    <span style="color:#666">});</span>
<span style="color:#666">}</span>
</code></pre></div><p><code>Operator</code>的具体实现可以参考<a href="https://github.com/ReactiveX/RxJava/blob/1.x/src/main/java/rx/internal/operators/OnSubscribeFilter.java" target="_blank"><code>OperatorFilter</code></a></p><blockquote><p>调用流程的理解可以使用递归思想<br> <strong>Subscriber</strong>: 动作的发起者, 结果的获取者<br> <strong>整体过程</strong>: 下游流向上游, 上游再流回下游的一个过程</p></blockquote><p></p><figure class="image-label"><img data-original="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2019/10/15719204624118.jpg" alt="多次的lift的流程图"><figcaption>多次的lift的流程图</figcaption></figure><p></p><h2 id="在扫码枪中自定义操作符的应用">在扫码枪中自定义操作符的应用</h2><p>将扫码枪输入的一个一个的按键事件(KeyEvent), 缓存起来再达到条件时全部发送出去</p><p>本来事情很简单, 只要接受到回车键(ENTER)就发送出去, 但是却存在一些扫码枪一次扫码最后不会发送回车键.<br> 所以可以使用扫码枪共有特征, 就是每个按键事件的间隔很短, 可用找到一个比较合适的时间阈值来鉴别是否为一次扫码.</p><p>所以, 这个操作符的功能就是<strong>在条件下进行缓存</strong>, 我们给它起个名字叫<code>BufferWhile</code></p><h3 id="bufferwhile">BufferWhile</h3><details><summary>代码点击展开</summary><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic"> * BufferWhile, buffer while some predicate allows it based on the items.
</span><span style="color:#60a0b0;font-style:italic"> * Notice: the operator not emit the last item.
</span><span style="color:#60a0b0;font-style:italic"> * Changes: auto start loop checker
</span><span style="color:#60a0b0;font-style:italic"> * refer:
</span><span style="color:#60a0b0;font-style:italic"> * 1. https://github.com/akarnokd/RxJavaExtensions/blob/master/src/main/java/hu/akarnokd/rxjava2/operators/FlowableBufferPredicate.java
</span><span style="color:#60a0b0;font-style:italic"> * 2. https://stackoverflow.com/questions/35881227/rxjava-buffer-items-until-some-condition-is-true-for-current-item
</span><span style="color:#60a0b0;font-style:italic"> * Created by qbeenslee on 2019-09-06.
</span><span style="color:#60a0b0;font-style:italic"> */</span>
<span style="color:#555;font-weight:700">@BackpressureSupport</span><span style="color:#666">(</span>BackpressureKind<span style="color:#666">.</span><span style="color:#4070a0">FULL</span><span style="color:#666">)</span>
<span style="color:#007020;font-weight:700">public</span> <span style="color:#007020;font-weight:700">class</span> <span style="color:#0e84b5;font-weight:700">BufferWhile</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span> <span style="color:#007020;font-weight:700">implements</span> Observable<span style="color:#666">.</span><span style="color:#4070a0">Operator</span><span style="color:#666">&lt;</span>List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;,</span> T<span style="color:#666">&gt;</span> <span style="color:#666">{</span>
    <span style="color:#007020;font-weight:700">private</span> <span style="color:#007020;font-weight:700">final</span> Func1<span style="color:#666">&lt;</span>T<span style="color:#666">,</span> Boolean<span style="color:#666">&gt;</span> predicate<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:700">private</span> <span style="color:#007020;font-weight:700">final</span> <span style="color:#902000">long</span> timeout<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:700">private</span> <span style="color:#007020;font-weight:700">final</span> TimeUnit timeUnit<span style="color:#666">;</span>
    <span style="color:#007020;font-weight:700">private</span> <span style="color:#007020;font-weight:700">final</span> <span style="color:#902000">long</span> duration<span style="color:#666">;</span> <span style="color:#60a0b0;font-style:italic">//NANOSECONDS
</span><span style="color:#60a0b0;font-style:italic"></span>    <span style="color:#007020;font-weight:700">private</span> <span style="color:#007020;font-weight:700">final</span> Scheduler scheduler<span style="color:#666">;</span>


    <span style="color:#007020;font-weight:700">public</span> <span style="color:#06287e">BufferWhile</span><span style="color:#666">(</span>Func1<span style="color:#666">&lt;</span>T<span style="color:#666">,</span> Boolean<span style="color:#666">&gt;</span> predicate<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:700">this</span><span style="color:#666">(</span>0L<span style="color:#666">,</span> TimeUnit<span style="color:#666">.</span><span style="color:#4070a0">SECONDS</span><span style="color:#666">,</span> predicate<span style="color:#666">,</span> Schedulers<span style="color:#666">.</span><span style="color:#4070a0">computation</span><span style="color:#666">());</span>
    <span style="color:#666">}</span>

    <span style="color:#007020;font-weight:700">public</span> <span style="color:#06287e">BufferWhile</span><span style="color:#666">(</span><span style="color:#902000">long</span> timeout<span style="color:#666">,</span> TimeUnit unit<span style="color:#666">,</span> Func1<span style="color:#666">&lt;</span>T<span style="color:#666">,</span> Boolean<span style="color:#666">&gt;</span> predicate<span style="color:#666">,</span> <span style="color:#555;font-weight:700">@NonNull</span> Scheduler scheduler<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">predicate</span> <span style="color:#666">=</span> predicate<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">timeout</span> <span style="color:#666">=</span> timeout<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">timeUnit</span> <span style="color:#666">=</span> unit<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">duration</span> <span style="color:#666">=</span> timeUnit <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">null</span> <span style="color:#666">?</span> timeUnit<span style="color:#666">.</span><span style="color:#4070a0">toNanos</span><span style="color:#666">(</span>timeout<span style="color:#666">)</span> <span style="color:#666">:</span> 0<span style="color:#666">;</span>
        <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">scheduler</span> <span style="color:#666">=</span> scheduler<span style="color:#666">;</span>
    <span style="color:#666">}</span>

    <span style="color:#555;font-weight:700">@Override</span>
    <span style="color:#007020;font-weight:700">public</span> Subscriber<span style="color:#666">&lt;?</span> <span style="color:#007020;font-weight:700">super</span> T<span style="color:#666">&gt;</span> <span style="color:#06287e">call</span><span style="color:#666">(</span><span style="color:#555;font-weight:700">@NonNull</span> Subscriber<span style="color:#666">&lt;?</span> <span style="color:#007020;font-weight:700">super</span> List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;&gt;</span> child<span style="color:#666">)</span> <span style="color:#666">{</span>
        SerializedSubscriber<span style="color:#666">&lt;</span>List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;&gt;</span> serialized <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">new</span> SerializedSubscriber<span style="color:#666">&lt;&gt;(</span>child<span style="color:#666">);</span>
        Scheduler<span style="color:#666">.</span><span style="color:#4070a0">Worker</span> inner <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">scheduler</span><span style="color:#666">.</span><span style="color:#4070a0">createWorker</span><span style="color:#666">();</span>
        BufferWhileSubscriber parent <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">new</span> BufferWhileSubscriber<span style="color:#666">(</span>serialized<span style="color:#666">,</span> inner<span style="color:#666">);</span>
        parent<span style="color:#666">.</span><span style="color:#4070a0">add</span><span style="color:#666">(</span>inner<span style="color:#666">);</span>
        child<span style="color:#666">.</span><span style="color:#4070a0">add</span><span style="color:#666">(</span>parent<span style="color:#666">);</span>

        parent<span style="color:#666">.</span><span style="color:#4070a0">scheduleExact</span><span style="color:#666">();</span>
        <span style="color:#007020;font-weight:700">return</span> parent<span style="color:#666">;</span>
    <span style="color:#666">}</span>


    <span style="color:#007020;font-weight:700">final</span> <span style="color:#007020;font-weight:700">class</span> <span style="color:#0e84b5;font-weight:700">BufferWhileSubscriber</span> <span style="color:#007020;font-weight:700">extends</span> Subscriber<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span> <span style="color:#666">{</span>
        <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">         * child
</span><span style="color:#60a0b0;font-style:italic">         */</span>
        <span style="color:#007020;font-weight:700">final</span> Subscriber<span style="color:#666">&lt;?</span> <span style="color:#007020;font-weight:700">super</span> List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;&gt;</span> actual<span style="color:#666">;</span>
        <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">         * Loop
</span><span style="color:#60a0b0;font-style:italic">         */</span>
        <span style="color:#007020;font-weight:700">final</span> Scheduler<span style="color:#666">.</span><span style="color:#4070a0">Worker</span> inner<span style="color:#666">;</span>
        <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">         * 缓存的数据
</span><span style="color:#60a0b0;font-style:italic">         */</span>
        <span style="color:#555;font-weight:700">@Nullable</span>
        <span style="color:#007020;font-weight:700">private</span> List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span> buffer<span style="color:#666">;</span>
        <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">         * 是否开启轮询
</span><span style="color:#60a0b0;font-style:italic">         */</span>
        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">boolean</span> isLoopActivated <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">false</span><span style="color:#666">;</span>

        <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">         * 发射次数
</span><span style="color:#60a0b0;font-style:italic">         */</span>
        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">long</span> emitCount <span style="color:#666">=</span> 0<span style="color:#666">;</span>

        <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">         * 单次初始接收时间
</span><span style="color:#60a0b0;font-style:italic">         */</span>
        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">long</span> initialTimestamp <span style="color:#666">=</span> 0<span style="color:#666">;</span>

        <span style="color:#60a0b0;font-style:italic">/**
</span><span style="color:#60a0b0;font-style:italic">         * 接收到上次信号的时间
</span><span style="color:#60a0b0;font-style:italic">         */</span>
        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">long</span> lastTimestamp <span style="color:#666">=</span> 0<span style="color:#666">;</span>


        BufferWhileSubscriber<span style="color:#666">(</span>Subscriber<span style="color:#666">&lt;?</span> <span style="color:#007020;font-weight:700">super</span> List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;&gt;</span> actual<span style="color:#666">,</span> Scheduler<span style="color:#666">.</span><span style="color:#4070a0">Worker</span> inner<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">actual</span> <span style="color:#666">=</span> actual<span style="color:#666">;</span>
            <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">inner</span> <span style="color:#666">=</span> inner<span style="color:#666">;</span>
            buffer <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">new</span> LinkedList<span style="color:#666">&lt;&gt;();</span> <span style="color:#60a0b0;font-style:italic">// 由于逻辑特性, 此处采取LinkedList获取更好的性能
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#666">}</span>

        <span style="color:#555;font-weight:700">@SuppressWarnings</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;unstable&#34;</span><span style="color:#666">)</span>
        <span style="color:#555;font-weight:700">@Override</span>
        <span style="color:#007020;font-weight:700">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">onNext</span><span style="color:#666">(</span>T t<span style="color:#666">)</span> <span style="color:#666">{</span>
            <span style="color:#60a0b0;font-style:italic">// 每次接收发射后
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">(</span>buffer <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">null</span> <span style="color:#666">&amp;&amp;</span> buffer<span style="color:#666">.</span><span style="color:#4070a0">isEmpty</span><span style="color:#666">())</span> <span style="color:#666">{</span>
                resetPeriodically<span style="color:#666">();</span>
            <span style="color:#666">}</span>

            <span style="color:#902000">boolean</span> accept <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">false</span><span style="color:#666">;</span>
            <span style="color:#007020;font-weight:700">try</span> <span style="color:#666">{</span>
                accept <span style="color:#666">=</span> predicate<span style="color:#666">.</span><span style="color:#4070a0">call</span><span style="color:#666">(</span>t<span style="color:#666">);</span>
            <span style="color:#666">}</span> <span style="color:#007020;font-weight:700">catch</span> <span style="color:#666">(</span>Throwable error<span style="color:#666">)</span> <span style="color:#666">{</span>
                Exceptions<span style="color:#666">.</span><span style="color:#4070a0">throwOrReport</span><span style="color:#666">(</span>error<span style="color:#666">,</span> <span style="color:#007020;font-weight:700">this</span><span style="color:#666">);</span>
            <span style="color:#666">}</span>

            <span style="color:#007020;font-weight:700">synchronized</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:700">this</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">(</span>accept<span style="color:#666">)</span> <span style="color:#666">{</span>
                    <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">(</span>buffer <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                        buffer<span style="color:#666">.</span><span style="color:#4070a0">add</span><span style="color:#666">(</span>t<span style="color:#666">);</span> <span style="color:#60a0b0;font-style:italic">// 不添加最后一个对象
</span><span style="color:#60a0b0;font-style:italic"></span>                    <span style="color:#666">}</span>
                <span style="color:#666">}</span> <span style="color:#007020;font-weight:700">else</span> <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">(</span>buffer <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">null</span> <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!</span>buffer<span style="color:#666">.</span><span style="color:#4070a0">isEmpty</span><span style="color:#666">())</span> <span style="color:#666">{</span>
                    emit<span style="color:#666">();</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>
            checkAndActivate<span style="color:#666">();</span>

            lastTimestamp <span style="color:#666">=</span> now<span style="color:#666">();</span> <span style="color:#60a0b0;font-style:italic">// 刷新每次接收的时间戳
</span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#666">}</span>

        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">long</span> <span style="color:#06287e">now</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:700">return</span> System<span style="color:#666">.</span><span style="color:#4070a0">nanoTime</span><span style="color:#666">();</span>
        <span style="color:#666">}</span>

        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">void</span> <span style="color:#06287e">emit</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span> toEmit <span style="color:#666">=</span> buffer<span style="color:#666">;</span>
            buffer <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">new</span> LinkedList<span style="color:#666">&lt;&gt;();</span> <span style="color:#60a0b0;font-style:italic">// 重置
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#007020;font-weight:700">try</span> <span style="color:#666">{</span>
                actual<span style="color:#666">.</span><span style="color:#4070a0">onNext</span><span style="color:#666">(</span>toEmit<span style="color:#666">);</span>
                emitCount<span style="color:#666">++;</span>
            <span style="color:#666">}</span> <span style="color:#007020;font-weight:700">catch</span> <span style="color:#666">(</span>Throwable error<span style="color:#666">)</span> <span style="color:#666">{</span>
                Exceptions<span style="color:#666">.</span><span style="color:#4070a0">throwOrReport</span><span style="color:#666">(</span>error<span style="color:#666">,</span> <span style="color:#007020;font-weight:700">this</span><span style="color:#666">);</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>

        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">void</span> <span style="color:#06287e">resetPeriodically</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            initialTimestamp <span style="color:#666">=</span> now<span style="color:#666">();</span>
        <span style="color:#666">}</span>

        <span style="color:#555;font-weight:700">@Override</span>
        <span style="color:#007020;font-weight:700">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">onError</span><span style="color:#666">(</span>Throwable e<span style="color:#666">)</span> <span style="color:#666">{</span>
            buffer <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">null</span><span style="color:#666">;</span>
            actual<span style="color:#666">.</span><span style="color:#4070a0">onError</span><span style="color:#666">(</span>e<span style="color:#666">);</span>
            <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">unsubscribe</span><span style="color:#666">();</span>
        <span style="color:#666">}</span>

        <span style="color:#555;font-weight:700">@Override</span>
        <span style="color:#007020;font-weight:700">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">onCompleted</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">inner</span><span style="color:#666">.</span><span style="color:#4070a0">unsubscribe</span><span style="color:#666">();</span>
            <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">(</span>buffer <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">null</span> <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!</span>buffer<span style="color:#666">.</span><span style="color:#4070a0">isEmpty</span><span style="color:#666">())</span> <span style="color:#666">{</span>
                emit<span style="color:#666">();</span>
            <span style="color:#666">}</span>
            actual<span style="color:#666">.</span><span style="color:#4070a0">onCompleted</span><span style="color:#666">();</span>
            <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">unsubscribe</span><span style="color:#666">();</span>
            lastTimestamp <span style="color:#666">=</span> 0L<span style="color:#666">;</span>
            initialTimestamp <span style="color:#666">=</span> 0L<span style="color:#666">;</span>
            isLoopActivated <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">false</span><span style="color:#666">;</span>
            emitCount <span style="color:#666">=</span> 0L<span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">void</span> <span style="color:#06287e">checkAndActivate</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">(</span>isLoopActivated<span style="color:#666">)</span> <span style="color:#007020;font-weight:700">return</span><span style="color:#666">;</span>
            <span style="color:#902000">long</span> now <span style="color:#666">=</span> now<span style="color:#666">();</span>
            <span style="color:#902000">boolean</span> shouldActivate <span style="color:#666">=</span> emitCount <span style="color:#666">==</span> 0 <span style="color:#60a0b0;font-style:italic">// 发射次数为0
</span><span style="color:#60a0b0;font-style:italic"></span>                    <span style="color:#666">&amp;&amp;</span> buffer <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">null</span> <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!</span>buffer<span style="color:#666">.</span><span style="color:#4070a0">isEmpty</span><span style="color:#666">()</span> <span style="color:#60a0b0;font-style:italic">// 缓存数据不为空
</span><span style="color:#60a0b0;font-style:italic"></span>                    <span style="color:#666">&amp;&amp;</span> initialTimestamp <span style="color:#666">!=</span> 0L <span style="color:#666">&amp;&amp;</span> duration <span style="color:#666">&lt;=</span> <span style="color:#666">(</span>now <span style="color:#666">-</span> initialTimestamp<span style="color:#666">);</span> <span style="color:#60a0b0;font-style:italic">// 距离初次接受时间大于指定间隔
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">(</span>shouldActivate <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!</span>isLoopActivated<span style="color:#666">)</span> <span style="color:#666">{</span>
                scheduleExact<span style="color:#666">();</span>
                isLoopActivated <span style="color:#666">=</span> <span style="color:#007020;font-weight:700">true</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>

        <span style="color:#902000">void</span> <span style="color:#06287e">scheduleExact</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:700">this</span><span style="color:#666">.</span><span style="color:#4070a0">inner</span><span style="color:#666">.</span><span style="color:#4070a0">schedulePeriodically</span><span style="color:#666">(</span><span style="color:#007020;font-weight:700">new</span> Action0<span style="color:#666">()</span> <span style="color:#666">{</span>
                <span style="color:#007020;font-weight:700">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">call</span><span style="color:#666">()</span> <span style="color:#666">{</span>
                    <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">(</span>test<span style="color:#666">())</span> <span style="color:#666">{</span>
                        emit<span style="color:#666">();</span>
                    <span style="color:#666">}</span>
                <span style="color:#666">}</span>
            <span style="color:#666">},</span> timeout<span style="color:#666">,</span> timeout<span style="color:#666">,</span> timeUnit<span style="color:#666">);</span>
        <span style="color:#666">}</span>

        <span style="color:#007020;font-weight:700">private</span> <span style="color:#902000">boolean</span> <span style="color:#06287e">test</span><span style="color:#666">()</span> <span style="color:#666">{</span>
            <span style="color:#007020;font-weight:700">synchronized</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:700">this</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                <span style="color:#902000">long</span> now <span style="color:#666">=</span> now<span style="color:#666">();</span>
                <span style="color:#007020;font-weight:700">return</span> buffer <span style="color:#666">!=</span> <span style="color:#007020;font-weight:700">null</span> <span style="color:#666">&amp;&amp;</span> <span style="color:#666">!</span>buffer<span style="color:#666">.</span><span style="color:#4070a0">isEmpty</span><span style="color:#666">()</span> <span style="color:#60a0b0;font-style:italic">// 缓存数据不为空
</span><span style="color:#60a0b0;font-style:italic"></span>                        <span style="color:#666">&amp;&amp;</span> lastTimestamp <span style="color:#666">!=</span> 0L <span style="color:#666">&amp;&amp;</span> duration <span style="color:#666">&lt;</span> <span style="color:#666">(</span>now <span style="color:#666">-</span> lastTimestamp<span style="color:#666">);</span> <span style="color:#60a0b0;font-style:italic">//距离上一个接受到信号超过指定间隔
</span><span style="color:#60a0b0;font-style:italic"></span>            <span style="color:#666">}</span>
        <span style="color:#666">}</span>

    <span style="color:#666">}</span>
<span style="color:#666">}</span>
</code></pre></div><blockquote><p><strong>思考题</strong>: 如何区分扫码枪输入和键盘手动输入?</p></blockquote></details><div class="article-copyright"><p>文章作者: <a href="https://qbeenslee.com/article/rxjava-custom-operator-with-bracode-gun/"><i>qbeenslee</i></a></p> <a href="/copyright/"><img src="https://qbeenslee.com/img/cc-by-nc-nd.svg" height="20px" width="93px" class="nozoom"></a></div></div></article></div><div class="comment-wrap horizontal-safe unselectable" style="padding-left:20px;padding-right:20px"><style>#vcomments .info,.at,.vcontent>a[href^="#"],.vcopy,.vlink,.vmail,.vpower,.vsys{display:none!important}.v .vlist .vcard{padding-top:0!important}.v code,.v pre{font-size:100%!important}.vinput{border:none!important}.vheader{border-bottom:1px dashed #dedede}</style><section class="section-content unselectable"><div id="vcomments" class="container"></div></section><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",lang:"zh-cn",appId:"G3MMP8E4DNTqvCPV48o7Ph23-gzGzoHsz",appKey:"jYCgILtFpGK1vJUJSE5TtIIs",notify:!1,verify:!1,avatar:"hide",visitor:!1,recordIP:!0,placeholder:"随便说点啥~~"})</script></div></div></div></main><footer class="section site_footer_grap unselectable"><div class="has-text-centered"><p>&copy;Qbeenslee 2020</p></div></footer><script type="text/javascript" src="https://qbeenslee.com/js/main-7dad4f9259.js"></script><script type="text/javascript" src="https://qbeenslee.com/js/load-photoswipe-59804a3a3b.js"></script><script type="text/javascript" src="https://qbeenslee.com/lib/photoswipe/photoswipe-93bfb21f06.min.js"></script><script type="text/javascript" src="https://qbeenslee.com/lib/photoswipe/photoswipe-ui-default-90277326f4.min.js"></script><script type="text/javascript">var imgs=$("img");imgs.on("contextmenu",function(){return!1}),imgs.on("dragstart",function(){return!1})</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?58b3c65a09f5aacd0e62efe29897c7e4";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body></html>