<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"><title>Rxjava自定义操作符与扫码枪 | Hey sister</title><meta name="description" content="Rxjava自定义操作符在扫码枪中的应用"><meta name="keywords" content="rxjava,android,barcode-gun"><meta name="author" content="qbeenslee"><meta name="msapplication-TileColor" content="#ffffff"><meta name="theme-color" content="#ffffff"><meta property="theme-config" content="protectImage,list"><meta property="og:title" content="Rxjava自定义操作符与扫码枪 | Hey sister"><meta property="og:description" content="Rxjava自定义操作符在扫码枪中的应用"><meta property="og:url" content="https://qbeenslee.com/article/rxjava-custom-operator-with-bracode-gun/"><meta property="og:site_name" content="Hey sister"><meta property="og:type" content="article"><meta property="og:image" content="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2019/10/rxjavawithandroid.png"><meta property="article:published_time" content="2019-10-24T20:33:26&#43;08:00"><meta property="article:modified_time" content="2019-10-24T20:33:26&#43;08:00"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><link rel="alternate" type="application/rss+xml" title="Hey sister" href="https://qbeenslee.com/index.xml"><link rel="stylesheet" href="https://qbeenslee.com/css/main-49b239d526.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="preload" as="image" href="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2019/10/rxjavawithandroid.png"><script src="https://qbeenslee.com/js/darkmode-09dcfb2235.js" type="text/javascript"></script><script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.6.0.min.js" type="text/javascript"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js" type="text/javascript"></script></head><body style="background-color:#f2f2f2"><header id="header" class="auto_header nav-trans" style="top:0;position:fixed;z-index:1100"><div id="navigation-bar" class="unselectable flex"><div class="nav-left"><div class="logo"><a class="nav-with-shadow nav-color-subject" href="/">Hey sister</a></div></div><div class="nav-middle horizontal-scroll"><nav><div class="nav-item"> <a class="nav-color-normal" href="/bb/">小声BB</a></div><div class="nav-item dropdown"> <a class="dropbtn nav-color-normal">归档<span class="caret"></span></a><div class="dropdown-content"> <a href="/archives/">全部</a><a href="/categories/">类目</a><a href="/tags/">标签</a></div></div><div class="nav-item dropdown"> <a class="dropbtn nav-color-normal">工具<span class="caret"></span></a><div class="dropdown-content"> <a href="https://json.qbeenslee.com">JSON</a><a href="/article/test/">测试</a><a href="/index.xml">订阅</a></div></div><div class="nav-item dropdown"> <a class="dropbtn nav-color-normal">关于<span class="caret"></span></a><div class="dropdown-content"> <a href="/about/me/">关于我</a><a href="/friends/">友情链接</a><a href="/about/website/">技术说明</a><a href="/copyright/">版权声明</a><a href="/privacy/">隐私条款</a><a href="https://qbeenslee.com/hugo-theme-fragment/">帮助文档</a></div></div></nav></div><div class="nav-right"><div class="nav-item" title="搜索"><div class="search-button nav-with-shadow nav-color-subject"><i onclick="toggleSearch()" class="icon large search"></i></div><div class="search-box"><div class="search"><div class="input"> <input class="prompt" maxlength="1000" autocomplete="off" type="text" placeholder="搜索"></div><div class="results"></div></div></div></div><div class="nav-item" title="夜晚模式"><div class="nav-with-shadow nav-color-subject"><i onclick="toggleDarkmode()" class="icon large" id="darkmode-switcher"></i></div></div></div></div></header><main style="background-color:var(--bg)" class="page"><div id="banner" class="banner small"><div class="banner-wrap"><img class="nozoom cover lazyload" alt="banner" data-src="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2019/10/rxjavawithandroid.png" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs="></div></div><div id="page"><div class="horizontal-safe vertical-safe-covered"><div class="page-wrapper"><div class="middle-side"><article><div class="article-header"><h1 class="title">Rxjava自定义操作符与扫码枪</h1> <span class="subtitle">本文创作于2019年10月24日 20:33</span></div><div class="content" id="content"><p>正是Rxjava丰富的操作符, 简化了我们的日常开发的工作量. 本文将介绍Rxjava自定义操作符在实际开发中的应用.</p><h2 id="操作符应用举例">操作符应用举例</h2><p>下面是一个使用例子:</p><div class="highlight"><pre tabindex="0" class="chroma code-java"><div class="prefix"></div><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//加购凑单逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">fun</span> <span class="nf">shoppingCartGoods</span><span class="o">(</span><span class="n">act</span><span class="o">:</span> <span class="n">RaiseBuyActBO</span><span class="o">,</span> <span class="n">goods</span><span class="o">:</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ActivityGoodsBO</span><span class="o">&gt;?,</span> <span class="n">limit</span><span class="o">:</span> <span class="n">Int</span><span class="o">)</span> <span class="o">=</span> <span class="n">Observable</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">goods</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">subscribeOn</span><span class="o">(</span><span class="n">Schedulers</span><span class="o">.</span><span class="na">computation</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">observeOn</span><span class="o">(</span><span class="n">AndroidSchedulers</span><span class="o">.</span><span class="na">mainThread</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">flatMapIterable</span> <span class="o">{</span> <span class="n">it</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">filter</span> <span class="o">{</span> <span class="n">MarketingLogic</span><span class="o">.</span><span class="na">isActivityGoods</span><span class="o">(</span><span class="n">act</span><span class="o">.</span><span class="na">rangeTypeIsAll</span><span class="o">(),</span> <span class="n">act</span><span class="o">.</span><span class="na">filterGoodsIds</span><span class="o">(),</span> <span class="n">it</span><span class="o">.</span><span class="na">goodsId</span><span class="o">)</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">distinct</span> <span class="o">{</span> <span class="n">it</span><span class="o">.</span><span class="na">goodsId</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">take</span><span class="o">(</span><span class="n">limit</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">map</span> <span class="o">{</span> <span class="n">it</span><span class="o">.</span><span class="na">goodsId</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">toList</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">flatMap</span> <span class="o">{</span> <span class="n">GoodsDao</span><span class="o">.</span><span class="na">getGoodsById</span><span class="o">(</span><span class="n">it</span><span class="o">)</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">flatMapIterable</span> <span class="o">{</span> <span class="n">it</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">take</span><span class="o">(</span><span class="n">limit</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">toList</span><span class="o">()</span>
</span></span></code></pre></div><p></p><figure class="image-dialog"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://raw.githubusercontent.com/qbeenslee/img/master/202209/17_81c1f0.jpg" alt="Rxjava操作符大全"><figcaption>Rxjava操作符大全</figcaption></figure><p></p><h2 id="操作符的实现原理">操作符的实现原理</h2><blockquote><p>操作符是如何实现的, 它的调度流程是怎么样的?</p></blockquote><p>简化<a href="https://github.com/ReactiveX/RxJava/blob/1.x/src/main/java/rx/internal/operators/OnSubscribeLift.java" target="_blank"><code>OnSubscribeLift</code></a> 只保留核心逻辑如下:</p><div class="highlight"><pre tabindex="0" class="chroma code-java"><div class="prefix"></div><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="nf">lift</span><span class="o">(</span><span class="n">Operator</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">R</span><span class="o">,</span> <span class="o">?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Observable</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="n">OnSubscribe</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">Subscriber</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Subscriber</span> <span class="n">newSubscriber</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="n">subscriber</span><span class="o">);</span> <span class="c1">//All starting with subscribe()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">newSubscriber</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span> <span class="c1">//Default do nothing 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">onSubscribe</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="n">newSubscriber</span><span class="o">);</span> <span class="c1">//Observable.this.onSubscribe
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><code>Operator</code>的具体实现可以参考<a href="https://github.com/ReactiveX/RxJava/blob/1.x/src/main/java/rx/internal/operators/OnSubscribeFilter.java" target="_blank"><code>OperatorFilter</code></a></p><blockquote><p>调用流程的理解可以使用递归思想<br> <strong>Subscriber</strong>: 动作的发起者, 结果的获取者<br> <strong>整体过程</strong>: 下游流向上游, 上游再流回下游的一个过程</p></blockquote><figure class="image-dialog"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://raw.githubusercontent.com/qbeenslee/img/master/202209/17_b26223.jpg" alt="多次的lift的流程图" width="450px"><figcaption>多次的lift的流程图</figcaption></figure><h2 id="在扫码枪中自定义操作符的应用">在扫码枪中自定义操作符的应用</h2><p>将扫码枪输入的一个一个的按键事件(KeyEvent), 缓存起来再达到条件时全部发送出去.</p><p>本来事情很简单, 只要接受到回车键(ENTER)就发送出去, 但是却存在一些扫码枪一次扫码最后不会发送回车键. 所以可以使用扫码枪共有特征, 就是每个按键事件的间隔很短, 可用找到一个比较合适的时间阈值来鉴别是否为一次扫码.</p><p>所以, 这个操作符的功能就是<strong>在条件下进行缓存</strong>, 我们给它起个名字叫<code>BufferWhile</code></p><h3 id="bufferwhile">BufferWhile</h3><div class="highlight"><pre tabindex="0" class="chroma code-java"><div class="prefix"></div><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * BufferWhile, buffer while some predicate allows it based on the items.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Notice: the operator not emit the last item.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Changes: auto start loop checker
</span></span></span><span class="line"><span class="cl"><span class="cm"> * refer:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. https://github.com/akarnokd/RxJavaExtensions/blob/master/src/main/java/hu/akarnokd/rxjava2/operators/FlowableBufferPredicate.java
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. https://stackoverflow.com/questions/35881227/rxjava-buffer-items-until-some-condition-is-true-for-current-item
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Created by qbeenslee on 2019-09-06.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nd">@BackpressureSupport</span><span class="o">(</span><span class="n">BackpressureKind</span><span class="o">.</span><span class="na">FULL</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BufferWhile</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">Observable</span><span class="o">.</span><span class="na">Operator</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Func1</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">duration</span><span class="o">;</span> <span class="c1">//NANOSECONDS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Scheduler</span> <span class="n">scheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">BufferWhile</span><span class="o">(</span><span class="n">Func1</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span> <span class="n">predicate</span><span class="o">,</span> <span class="n">Schedulers</span><span class="o">.</span><span class="na">computation</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">BufferWhile</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span> <span class="n">Func1</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">predicate</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">Scheduler</span> <span class="n">scheduler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">predicate</span> <span class="o">=</span> <span class="n">predicate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">timeUnit</span> <span class="o">=</span> <span class="n">unit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">duration</span> <span class="o">=</span> <span class="n">timeUnit</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">timeUnit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">)</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="nf">call</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">child</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SerializedSubscriber</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">serialized</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SerializedSubscriber</span><span class="o">&lt;&gt;(</span><span class="n">child</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Scheduler</span><span class="o">.</span><span class="na">Worker</span> <span class="n">inner</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">scheduler</span><span class="o">.</span><span class="na">createWorker</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">BufferWhileSubscriber</span> <span class="n">parent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferWhileSubscriber</span><span class="o">(</span><span class="n">serialized</span><span class="o">,</span> <span class="n">inner</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">parent</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">inner</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">child</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">parent</span><span class="o">.</span><span class="na">scheduleExact</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kd">class</span> <span class="nc">BufferWhileSubscriber</span> <span class="kd">extends</span> <span class="n">Subscriber</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * child
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">actual</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Loop
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Scheduler</span><span class="o">.</span><span class="na">Worker</span> <span class="n">inner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 缓存的数据
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Nullable</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 是否开启轮询
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isLoopActivated</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 发射次数
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="n">emitCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 单次初始接收时间
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="n">initialTimestamp</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 接收到上次信号的时间
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="n">lastTimestamp</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">BufferWhileSubscriber</span><span class="o">(</span><span class="n">Subscriber</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">actual</span><span class="o">,</span> <span class="n">Scheduler</span><span class="o">.</span><span class="na">Worker</span> <span class="n">inner</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">actual</span> <span class="o">=</span> <span class="n">actual</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">inner</span> <span class="o">=</span> <span class="n">inner</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span> <span class="c1">// 由于逻辑特性, 此处采取LinkedList获取更好的性能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unstable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 每次接收发射后
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">resetPeriodically</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">accept</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">accept</span> <span class="o">=</span> <span class="n">predicate</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Exceptions</span><span class="o">.</span><span class="na">throwOrReport</span><span class="o">(</span><span class="n">error</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">accept</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">buffer</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">t</span><span class="o">);</span> <span class="c1">// 不添加最后一个对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">buffer</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">emit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">checkAndActivate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">lastTimestamp</span> <span class="o">=</span> <span class="n">now</span><span class="o">();</span> <span class="c1">// 刷新每次接收的时间戳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="nf">now</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">emit</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">toEmit</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span> <span class="c1">// 重置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">actual</span><span class="o">.</span><span class="na">onNext</span><span class="o">(</span><span class="n">toEmit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">emitCount</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Exceptions</span><span class="o">.</span><span class="na">throwOrReport</span><span class="o">(</span><span class="n">error</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">resetPeriodically</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">initialTimestamp</span> <span class="o">=</span> <span class="n">now</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">actual</span><span class="o">.</span><span class="na">onError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">unsubscribe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCompleted</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">inner</span><span class="o">.</span><span class="na">unsubscribe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">buffer</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">emit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">actual</span><span class="o">.</span><span class="na">onCompleted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">unsubscribe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">lastTimestamp</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">initialTimestamp</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">isLoopActivated</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">emitCount</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkAndActivate</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isLoopActivated</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">shouldActivate</span> <span class="o">=</span> <span class="n">emitCount</span> <span class="o">==</span> <span class="n">0</span> <span class="c1">// 发射次数为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">&amp;&amp;</span> <span class="n">buffer</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">buffer</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="c1">// 缓存数据不为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">&amp;&amp;</span> <span class="n">initialTimestamp</span> <span class="o">!=</span> <span class="n">0L</span> <span class="o">&amp;&amp;</span> <span class="n">duration</span> <span class="o">&lt;=</span> <span class="o">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">initialTimestamp</span><span class="o">);</span> <span class="c1">// 距离初次接受时间大于指定间隔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">shouldActivate</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isLoopActivated</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">scheduleExact</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">isLoopActivated</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">scheduleExact</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">inner</span><span class="o">.</span><span class="na">schedulePeriodically</span><span class="o">(</span><span class="k">new</span> <span class="n">Action0</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">test</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">emit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">timeUnit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">buffer</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">buffer</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="c1">// 缓存数据不为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">&amp;&amp;</span> <span class="n">lastTimestamp</span> <span class="o">!=</span> <span class="n">0L</span> <span class="o">&amp;&amp;</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">lastTimestamp</span><span class="o">);</span> <span class="c1">//距离上一个接受到信号超过指定间隔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><blockquote><p><strong>思考题</strong>: 如何区分扫码枪输入和键盘手动输入?</p></blockquote><div class="article-copyright"><p>文章作者: <a href="https://qbeenslee.com/article/rxjava-custom-operator-with-bracode-gun/"><i>qbeenslee</i></a></p> <a href="/copyright/"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://qbeenslee.com/img/cc-by-nc-nd.svg" height="20px" width="93px" class="nozoom" alt="CC BY-NC 4.0" title="CC BY-NC 4.0"></a></div></div></article><div class="related"><h2 class="see-also">相关文章<ul><li><a href="/article/page-that-inmitate-keka/">只编写markdown文件模仿keka.io首页</a></li><li><a href="/article/hexo-theme-sausage-help/">hexo主题sausage</a></li><li><a href="/article/building-an-android-hotfix-architecture/">Android热修复架构杂谈</a></li><li><a href="/article/android-webview-302-redirect/">Android WebView内处理302重定向</a></li><li><a href="/article/about-wandoujia-proguard-config/">豌豆荚Android混淆字典, 眼睛要瞎了</a></li></ul></h2></div><div class="pagination-container flex flex-wrap"><div class="pagination-item pagination-item--previous"><a href="https://qbeenslee.com/article/hackintosh-machine-build-tutorial/"><div class="pagination-item-label"><svg width="10" height="16" viewBox="0 0 10 16" xmlns="http://www.w3.org/2000/svg"><polyline fill="none" vector-effect="non-scaling-stroke" points="8,2 2,8 8,14"></polyline></svg><span>上一章节</span></div><div class="pagination-item-title">黑苹果搭建之旅i7-9700K RX580 z390-itx</div></a></div><div class="pagination-item pagination-item--next"><a href="https://qbeenslee.com/article/why-choose-portable-monitor-2020/"><div class="pagination-item-label"> <span>下一章节</span><svg width="10" height="16" viewBox="0 0 10 16" xmlns="http://www.w3.org/2000/svg"><polyline fill="none" vector-effect="non-scaling-stroke" points="2,2 8,8 2,14"></polyline></svg></div><div class="pagination-item-title">作为开发者, 我为什么选择便携式显示器</div></a></div></div></div></div><div class="comment-wrap unselectable"><style>#vcomments .info,.at,.vcontent>a[href^="#"],.vcopy,.vlink,.vpower,.vsys{display:none!important}#vcomments{color:var(--text)}.v .vlist .vcard{padding-top:0!important}.v code,.v pre{font-size:100%!important}.vinput{border:none!important}.vheader{border-bottom:1px dashed var(--border-divide)!important}.v[data-class=v] .vwrap{border:1px solid var(--border-divide)!important}.v *{color:var(--text-suammary)!important}.v .vwrap{border:1px solid var(--border-light)!important}.v .vcards .vcard .vh{border-bottom:1px dashed var(--border-clear)!important}.v .vbtn{background:var(--block-similar)!important;border:1px solid var(--border-light)!important;color:var(--text-content)!important}</style><section class="section-content unselectable"><div id="vcomments" class="container"></div></section><script src="https://unpkg.com/valine@1.4.4/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",lang:"zh-cn",appId:"G3MMP8E4DNTqvCPV48o7Ph23-gzGzoHsz",appKey:"jYCgILtFpGK1vJUJSE5TtIIs",notify:!1,verify:!1,avatar:"hide",visitor:!1,recordIP:!1,placeholder:"随便说点啥~~"})</script></div></div></div></main><footer class="site_footer_grap unselectable"><div class="has-text-centered"><p>&copy;Qbeenslee 2022</p></div></footer><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script type="text/javascript" src="https://qbeenslee.com/js/main-4a2352a0fe.js"></script><script async type="text/javascript" src="https://hm.baidu.com/hm.js?58b3c65a09f5aacd0e62efe29897c7e4"></script></body></html>