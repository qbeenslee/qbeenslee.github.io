<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Android热修复架构杂谈 | Hey sister</title>
<meta property='og:title' content='Android热修复架构杂谈 - Hey sister'>
<meta property='og:description' content='与前后端相比, 移动端对热修复的需求更为迫切和复杂. iOS上已有JSPatch这套成熟并被官方默许的解决方案. 然而Android上的热修复方案的演进则曲折的多, 简述一下鄙人的心路历程.'>
<meta property='og:url' content='https://qbeenslee.com/article/building-an-android-hotfix-architecture/'>
<meta property='og:site_name' content='Hey sister'>
<meta property='og:type' content='article'><meta property='article:section' content='Article'><meta property='article:tag' content='android'><meta property='article:tag' content='hotfix'><meta property='article:published_time' content='2016-08-17T23:13:45&#43;08:00'/><meta property='article:modified_time' content='2016-08-17T23:13:45&#43;08:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@'><meta name='twitter:creator' content='@'>

<link href="https://qbeenslee.com/index.xml" rel="alternate" type="application/rss+xml" title="Hey sister" />


<link rel="stylesheet" href="https://qbeenslee.com/css/main.min.css"><link rel='stylesheet'  href="https://qbeenslee.com/css/custom.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<script src="/js/jquery.min.js" type="text/javascript"></script>

<script type="text/javascript" src="/js/leaflet.js"></script>
<link rel="stylesheet" href="/css/leaflet.css"/>
</head>

<body>
<header id="header" class="auto_header noselect" style="transition: top 0.3s ease-in-out; top: 0px; position: fixed; z-index: 9999;">
    
    <div class="site"><a href="/"><div class="title">Hey sister</div></a>
    </div>
    <div id="nav-bar">
        
        
        
        
        
        <nav class="nav-item level is-mobile">
            
            <a href="/gallery/" class="nav-color-normal">相册</a>
            
        </nav>
        
        
        
        <nav class="nav-item level is-mobile">
            
            <a href="/bb/" class="nav-color-normal">小声BB</a>
            
        </nav>
        
        
        
        <nav class="nav-item level is-mobile">
            
            <a href="/about/" class="nav-color-normal">关于</a>
            
        </nav>
        
        
    </div>
</header>

<main>
<div class="container">
    <h1 class="title">Android热修复架构杂谈</h1>
    <span class="subtitle">2016年8月17日 23:13</span>
    
    <div class="content">
      <p>与前后端相比, 移动端对<a href="https://zh.wikipedia.org/wiki/热修复" target="_blank">热修复</a>的需求更为迫切和复杂. iOS上已有<a href="http://dev.qq.com/topic/579efa7083355a9a57a1ac5b" target="_blank">JSPatch</a>这套成熟并被官方默许的解决方案. 然而Android上的热修复方案的演进则曲折的多, 简述一下鄙人的心路历程.</p>

<h2 id="dexposed">Dexposed</h2>

<p><a href="https://github.com/alibaba/dexposed" target="_blank">https://github.com/alibaba/dexposed</a></p>

<p>最早是在百川大会上听说这个方案, 但整个接入过程体验了一下真是吐了一口老血. 由于Dexposed不支持ART Runtime一开始就被放弃了.</p>

<h2 id="andfix">Andfix</h2>

<p><a href="https://github.com/alibaba/andfix" target="_blank">https://github.com/alibaba/andfix</a></p>

<p>真正尝试接入的热修复方案. 刚开始有其他公司的基友说是测试几百台手机都没有问题(幼稚的我竟然相信了), 然后就开始研究Andfix.</p>

<p>Andfix是一个可以实时修复的方案, 修复范围是方法, 具体是通过native hook java的方法反射运行补丁包中相应的方法来进行修复.</p>

<p>尼玛, 随着使用与测试的深入发现了许多坑一个一个填掉, 到最后上线还是遇到一些机型进行修复造成crash后立马下线掉了(兼容性问题). 其中还碰到ART模式下两个补丁同时修复同一个类会crash.</p>

<p>下面是测试后得出Andfix的修复范围:</p>

<table>
<thead>
<tr>
<th>修复内容</th>
<th align="center">是否支持</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>修改方法(使用的代码中不引入新的类)</td>
<td align="center">✔</td>
<td></td>
</tr>

<tr>
<td>新增方法</td>
<td align="center">✔</td>
<td></td>
</tr>

<tr>
<td>跨版本修复</td>
<td align="center">✗</td>
<td>版本名变化会删除差异包</td>
</tr>

<tr>
<td>添加新的域(成员变量)</td>
<td align="center">✗</td>
<td>差异包编译不通过</td>
</tr>

<tr>
<td>添加新的类</td>
<td align="center">✗</td>
<td>NoClassDefFoundError</td>
</tr>

<tr>
<td>在方法内添加新的内部类</td>
<td align="center">✗</td>
<td>NoClassDefFoundError</td>
</tr>

<tr>
<td>修改内部类里的方法(看操作的地方的this是否指向内部类)</td>
<td align="center">✗</td>
<td>NoClassDefFoundError</td>
</tr>

<tr>
<td>inline方法</td>
<td align="center">✗</td>
<td></td>
</tr>

<tr>
<td>参数超过8个或带有long,double或者float的方法</td>
<td align="center">✗</td>
<td></td>
</tr>
</tbody>
</table>

<blockquote>
<p>如有错误请给予指正</p>
</blockquote>

<p>其实Andfix是一套比较完善的热修复方案, 里面有许多思路值得借鉴. 但是考虑到如果继续投入精力在Andfix上所耗费的成本具有很大的不确定性, 遂放弃了Andfix.</p>

<blockquote>
<p>Ps: 现在github上开源的Andfix已经差不多是KPI项目了, 阿里内部已经出第二个版本了, 而且内部人士表示不会开源. 如果有后来者想继续研究Andfix, 可以反编译支付宝Android端的代码学习借鉴一下.</p>

<p>PPs: 安利一个反编译工具 <a href="https://github.com/skylot/jadx" target="_blank">jadx</a></p>
</blockquote>

<p><img src="https://i.imgur.com/mNVlDAt.jpg" alt="go die" /></p>

<h2 id="rocoofix">RocooFix</h2>

<p><a href="https://github.com/dodola/RocooFix" target="_blank">https://github.com/dodola/RocooFix</a></p>

<p>某日老司机发我一链接, 叫我看看这个热修复方案, 遂开始研究RocooFix.</p>

<p>RocooFix是基于<a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=16" target="_blank">Qzone热修复方案</a>的实践, 与之相似的还有<a href="https://github.com/jasonross/Nuwa" target="_blank">Nuwa</a>, <a href="https://github.com/dodola/HotFix" target="_blank">HotFix</a>. Qzone方案的修复范围Class级的替换(仅包括java文件, 不支持替换资源文件, so文件等), 而且需要在获取补丁后<strong>再次启动方可生效</strong>, 并将影响app启动速度(如果项目已经分包就忽略这条), 插桩具有一定的侵入性. 整个方案包括运行时工具和编译时工具, 运行时工具大致就是一套multidex框架, 编译时工具则主要是生成差异包和插桩.</p>

<p>RocooFix这套工具比较基础, 为了完善的热修复方案需要考虑到一些点:</p>

<ul>
<li>安全策略;<br /></li>
<li>重启管理;<br /></li>
<li>补丁更新;<br /></li>
<li>应用版本升级.<br />
<br /></li>
</ul>

<p>整体运行架构如图:</p>

<p><img src="https://i.imgur.com/GlpiIPl.png" alt="hotfix architecture" /></p>

<h3 id="安全策略">安全策略</h3>

<p>想起微信团队对<a href="http://dev.qq.com/topic/579efa7083355a9a57a1ac5b" target="_blank">JSPatch</a>安全处理方式是采用RSA签名验证, 并且Android发布release包的时候也是需要签名的. 所以何不利用Android keystore对补丁签名, 然后在下发时进行校验.</p>

<blockquote>
<p><img src="https://i.imgur.com/ell6mKJ.png" alt="jspatch safe" /></p>
</blockquote>

<p>所以需要在生成补丁后通过<code>SigningConfig</code>获取本地keystore签名信息并使用<a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/jarsigner.html" target="_blank"><code>jarsigner</code></a>对补丁进行签名. 为了方便, 使用中直接修改RocooFix的gradle插件模块的代码, 并发布到内网maven服务器上使用.</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="cm">/**
</span><span class="cm"> * Signing Jar with Android Keystore
</span><span class="cm"> * @param patchDir patch temple data directory
</span><span class="cm"> * @param variant build.gradle signing configuration 
</span><span class="cm"> * @return true, signing jar success
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">signJar</span><span class="o">(</span><span class="n">File</span> <span class="n">patchDir</span><span class="o">,</span> <span class="n">BaseVariant</span> <span class="n">variant</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">config</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="na">getBuildType</span><span class="o">().</span><span class="na">getSigningConfig</span><span class="o">()</span>

    <span class="kt">def</span> <span class="n">buildTypeName</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">buildTypeName</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s1">&#39;release&#39;</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="o">}</span>
    
    <span class="kt">def</span> <span class="n">patchFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">patchDir</span><span class="o">,</span> <span class="s2">&#34;patch.jar&#34;</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">patchFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">exec</span> <span class="o">=</span> <span class="n">JavaEnvUtils</span><span class="o">.</span><span class="na">getJdkExecutable</span><span class="o">(</span><span class="s1">&#39;jarsigner&#39;</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="s2">&#34;jarsigner&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">exec</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&#34;Cannot find JAVA_HOME in environment variables&#34;</span><span class="o">)</span>
        <span class="o">}</span>
    
        <span class="kt">def</span> <span class="n">storeFile</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getStoreFile</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">storePassword</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getStorePassword</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">keyAlias</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getKeyAlias</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">keyPassword</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getKeyPassword</span><span class="o">()</span>
        
        <span class="kt">def</span> <span class="n">signPatchFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">patchDir</span><span class="o">,</span> <span class="s2">&#34;patch_signed.jar&#34;</span><span class="o">)</span>
        <span class="n">copyJarFile</span><span class="o">(</span><span class="n">patchFile</span><span class="o">,</span> <span class="n">signPatchFile</span><span class="o">)</span>

        <span class="kt">def</span> <span class="n">command</span> <span class="o">=</span> <span class="s2">&#34;${exec} -tsa http://timestamp.digicert.com -keystore ${storeFile.absolutePath} -storepass ${storePassword} -keypass ${keyPassword} ${signPatchFile.absolutePath} ${keyAlias}&#34;</span>
        <span class="kt">def</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="na">execute</span><span class="o">()</span>
        <span class="n">proc</span><span class="o">.</span><span class="na">waitFor</span><span class="o">()</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">proc</span><span class="o">.</span><span class="na">exitValue</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">println</span> <span class="s2">&#34;Std Out: ${proc.in.text}&#34;</span>
            <span class="n">println</span> <span class="s2">&#34;CommandLine: ${command}&#34;</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">proc</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">println</span><span class="o">(</span><span class="s2">&#34;build signed jar success&#34;</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">println</span><span class="o">(</span><span class="s2">&#34;WARNING: PATCH FILE IS NOT EXISTS!!!&#34;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kt">void</span> <span class="nf">copyJarFile</span><span class="o">(</span><span class="n">File</span> <span class="n">src</span><span class="o">,</span> <span class="n">File</span> <span class="n">dest</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">input</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="na">newDataInputStream</span><span class="o">()</span>
    <span class="kt">def</span> <span class="n">output</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="na">newDataOutputStream</span><span class="o">()</span>
    <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="n">input</span>
    <span class="n">input</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
    <span class="n">output</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
<span class="o">}</span></code></pre></div>
<p>为了安全性, 实际使用中还采用了加密https来下发补丁文件.</p>

<h3 id="管理逻辑">管理逻辑</h3>

<p>现在要实现的最优目标是无感知的将bug给修复掉, 当然也可以在接收到新补丁后弹框让用户选择强制重启(万不得以的时候).</p>

<p>为实现无感知的修复bug避免重启给用户造成的困惑, 实际中会监听App退到后台, 此时如果存在新的补丁的话kill掉进程. 判断应用处于后台我是采用<a href="https://developer.android.com/reference/android/app/Application.ActivityLifecycleCallbacks.html" target="_blank">ActivityLifecycleCallbacks</a> (API level 14), 其他方案也可以参考<a href="https://github.com/wenmingvs/AndroidProcess" target="_blank">AndroidProcess</a>这个项目.</p>

<p>为了提高补丁的下发概率最好能配合推送服务.</p>

<blockquote>
<p>Ps: 以上都不包括RocooFix中实时修复的部分.</p>
</blockquote>

<h2 id="tinker">Tinker</h2>

<p><a href="https://github.com/zzz40500/Tinker_imitator" target="_blank">https://github.com/zzz40500/Tinker_imitator</a></p>

<p>还在研究中&hellip;</p>
      
    </div>
    
</div>


<style>
    #vcomments .info {display: none !important;}
    .vhead, .vheader, .at{display: none !important;}
    .v .vlist .vcard{padding-top: 0 !important;}
    .v code, .v pre{font-size:100% !important;}
</style>
<section class="section-content noselect">
    <div id="vcomments"  class="container"></div>
</section>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script>
new Valine({
    el:'#vcomments',
    appId:'G3MMP8E4DNTqvCPV48o7Ph23-gzGzoHsz',
    appKey:'jYCgILtFpGK1vJUJSE5TtIIs',
    notify:false, 
    verify:false, 
    avatar:'hide', 
    placeholder: '随便说点啥, 反正没人知道你是谁呀~~' 
});
</script>




</main>




<footer class="section site_footer_grap noselect">
  <div class="has-text-centered">
    <p>&copy; Qbeenslee 2019</p>
  </div>
</footer>
</body>
<script type="text/javascript" src="/js/auto_header.js"></script>
</html>

