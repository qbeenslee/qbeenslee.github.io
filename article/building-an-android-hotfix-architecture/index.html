<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"><title>Android热修复架构杂谈 | Hey sister</title><meta name="description" content="与前后端相比, 移动端对热修复的需求更为迫切和复杂. iOS上已有JSPatch这套成熟并被官方默许的解决方案. 然而Android上的热修复方案的演进则曲折的多, 简述一下鄙人的心路历程."><meta name="keywords" content="android,hotfix"><meta name="author" content="qbeenslee"><meta name="msapplication-TileColor" content="#ffffff"><meta name="theme-color" content="#ffffff"><meta property="config" content="protectImage"><meta property="og:title" content="Android热修复架构杂谈 | Hey sister"><meta property="og:description" content="与前后端相比, 移动端对热修复的需求更为迫切和复杂. iOS上已有JSPatch这套成熟并被官方默许的解决方案. 然而Android上的热修复方案的演进则曲折的多, 简述一下鄙人的心路历程."><meta property="og:url" content="https://qbeenslee.com/article/building-an-android-hotfix-architecture/"><meta property="og:site_name" content="Hey sister"><meta property="og:type" content="article"><meta property="article:section" content="Article"><meta property="article:tag" content="android"><meta property="article:tag" content="hotfix"><meta property="article:published_time" content="2016-08-17T23:13:45&#43;08:00"><meta property="article:modified_time" content="2016-08-17T23:13:45&#43;08:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><link rel="alternate" type="application/rss+xml" title="Hey sister" href="https://qbeenslee.com/index.xml"><link rel="stylesheet" href="https://qbeenslee.com/css/main-24016540e5.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><script src="https://qbeenslee.com/js/darkmode-1f40fc4a2d.js" type="text/javascript"></script><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js" type="text/javascript"></script><script src="https://cdn.bootcdn.net/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js" type="text/javascript"></script></head><body style="background-color:#fff" data-spy="scroll" data-target="#content-toc-tree" data-offset="90"><header id="header" class="auto_header unselectable nav-opaque" style="top:0;position:fixed;z-index:1100"><div class="nav-left"><nav><div class="logo nav-item"><a class="nav-with-shadow nav-color-subject" href="/">Hey sister</a></div><div class="nav-item"> <a class="nav-color-normal" href="/bb/">小声BB</a></div><div class="nav-item dropdown"> <a class="dropbtn nav-color-normal">归档<span class="caret"></span></a><div class="dropdown-content"> <a href="/tags/">标签</a><a href="/categories/">类目</a></div></div><div class="nav-item dropdown"> <a class="dropbtn nav-color-normal">关于<span class="caret"></span></a><div class="dropdown-content"> <a href="/about/me/">关于我</a><a href="/friends/">友情链接</a><a href="/about/website/">技术说明</a><a href="/copyright/">版权声明</a><a href="/privacy/">隐私条款</a><a href="/index.xml">订阅</a></div></div></nav></div><div class="nav-right"><div class="nav-item" title="夜晚模式"><div class="nav-with-shadow nav-color-subject"><i onclick="toggleDarkmode()" class="icon large" id="darkmode-switcher"></i></div></div><div class="nav-item" title="搜索"><div class="search-button nav-with-shadow nav-color-subject"><i onclick="toggleSearch()" class="icon large search"></i></div><div class="search-box"><div class="search"><div class="input"> <input class="prompt" maxlength="1000" autocomplete="off" type="text" placeholder="搜索"></div><div class="results"></div></div></div></div></div></header><main><div id="page" class="page"><div class="horizontal-safe vertical-safe"><div class="page-wrapper"><div class="middle-side"><article><div class="article-header"><h1 class="title">ANDROID热修复架构杂谈</h1><span class="subtitle">2016年8月17日 23:13</span></div><div class="content" id="content"><p>与前后端相比, 移动端对<a href="https://zh.wikipedia.org/wiki/%e7%83%ad%e4%bf%ae%e5%a4%8d" target="_blank">热修复</a>的需求更为迫切和复杂. iOS上已有<a href="http://dev.qq.com/topic/579efa7083355a9a57a1ac5b" target="_blank">JSPatch</a>这套成熟并被官方默许的解决方案. 然而Android上的热修复方案的演进则曲折的多, 简述一下鄙人的心路历程.</p><h2 id="dexposed">Dexposed</h2><p><a href="https://github.com/alibaba/dexposed" target="_blank">https://github.com/alibaba/dexposed</a></p><p>最早是在百川大会上听说这个方案, 但整个接入过程体验了一下真是吐了一口老血. 由于Dexposed不支持ART Runtime一开始就被放弃了.</p><h2 id="andfix">Andfix</h2><p><a href="https://github.com/alibaba/andfix" target="_blank">https://github.com/alibaba/andfix</a></p><p>真正尝试接入的热修复方案. 刚开始有其他公司的基友说是测试几百台手机都没有问题(幼稚的我竟然相信了), 然后就开始研究Andfix.</p><p>Andfix是一个可以实时修复的方案, 修复范围是方法, 具体是通过native hook java的方法反射运行补丁包中相应的方法来进行修复.</p><p>尼玛, 随着使用与测试的深入发现了许多坑一个一个填掉, 到最后上线还是遇到一些机型进行修复造成crash后立马下线掉了(兼容性问题). 其中还碰到ART模式下两个补丁同时修复同一个类会crash.</p><p>下面是测试后得出Andfix的修复范围:</p><div class="table-wrapper"><table><thead><tr><th>修复内容</th><th align="center">是否支持</th><th>备注</th></tr></thead><tbody><tr><td>修改方法(使用的代码中不引入新的类)</td><td align="center">✔</td><td></td></tr><tr><td>新增方法</td><td align="center">✔</td><td></td></tr><tr><td>跨版本修复</td><td align="center">✗</td><td>版本名变化会删除差异包</td></tr><tr><td>添加新的域(成员变量)</td><td align="center">✗</td><td>差异包编译不通过</td></tr><tr><td>添加新的类</td><td align="center">✗</td><td>NoClassDefFoundError</td></tr><tr><td>在方法内添加新的内部类</td><td align="center">✗</td><td>NoClassDefFoundError</td></tr><tr><td>修改内部类里的方法(看操作的地方的this是否指向内部类)</td><td align="center">✗</td><td>NoClassDefFoundError</td></tr><tr><td>inline方法</td><td align="center">✗</td><td></td></tr><tr><td>参数超过8个或带有long,double或者float的方法</td><td align="center">✗</td><td></td></tr></tbody></table></div><blockquote><p>如有错误请给予指正</p></blockquote><p>其实Andfix是一套比较完善的热修复方案, 里面有许多思路值得借鉴. 但是考虑到如果继续投入精力在Andfix上所耗费的成本具有很大的不确定性, 遂放弃了Andfix.</p><blockquote><p>Ps: 现在github上开源的Andfix已经差不多是KPI项目了, 阿里内部已经出第二个版本了, 而且内部人士表示不会开源. 如果有后来者想继续研究Andfix, 可以反编译支付宝Android端的代码学习借鉴一下.</p><p>PPs: 安利一个反编译工具 <a href="https://github.com/skylot/jadx" target="_blank">jadx</a></p></blockquote> <img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-original="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2020/06/mnvldat.jpg" alt="go die" class="nozoom"><h2 id="rocoofix">RocooFix</h2><p><a href="https://github.com/dodola/RocooFix" target="_blank">https://github.com/dodola/RocooFix</a></p><p>某日老司机发我一链接, 叫我看看这个热修复方案, 遂开始研究RocooFix.</p><p>RocooFix是基于<a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=16" target="_blank">Qzone热修复方案</a>的实践, 与之相似的还有<a href="https://github.com/jasonross/Nuwa" target="_blank">Nuwa</a>, <a href="https://github.com/dodola/HotFix" target="_blank">HotFix</a>. Qzone方案的修复范围Class级的替换(仅包括java文件, 不支持替换资源文件, so文件等), 而且需要在获取补丁后<strong>再次启动方可生效</strong>, 并将影响app启动速度(如果项目已经分包就忽略这条), 插桩具有一定的侵入性. 整个方案包括运行时工具和编译时工具, 运行时工具大致就是一套multidex框架, 编译时工具则主要是生成差异包和插桩.</p><p>RocooFix这套工具比较基础, 为了完善的热修复方案需要考虑到一些点:</p><ul><li>安全策略;</li><li>重启管理;</li><li>补丁更新;</li><li>应用版本升级.</li></ul><p>整体运行架构如图:</p><p></p><figure class="image-dialog"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-original="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2020/06/glpiipl.png" alt="hotfix architecture"><figcaption>hotfix architecture</figcaption></figure><p></p><h3 id="安全策略">安全策略</h3><p>想起微信团队对<a href="http://dev.qq.com/topic/579efa7083355a9a57a1ac5b" target="_blank">JSPatch</a>安全处理方式是采用RSA签名验证, 并且Android发布release包的时候也是需要签名的. 所以何不利用Android keystore对补丁签名, 然后在下发时进行校验.</p><blockquote><p></p><figure class="image-dialog"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-original="https://qbeenslee-1259354687.cos.ap-shanghai.myqcloud.com/2020/06/ell6mkj.png" alt="jspatch safe"><figcaption>jspatch safe</figcaption></figure><p></p></blockquote><p>所以需要在生成补丁后通过<code>SigningConfig</code>获取本地keystore签名信息并使用<a href="http://docs.oracle.com/javase/7/docs/technotes/tools/windows/jarsigner.html" target="_blank"><code>jarsigner</code></a>对补丁进行签名. 为了方便, 使用中直接修改RocooFix的gradle插件模块的代码, 并发布到内网maven服务器上使用.</p><div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="cm">/**
</span><span class="cm"> * Signing Jar with Android Keystore
</span><span class="cm"> * @param patchDir patch temple data directory
</span><span class="cm"> * @param variant build.gradle signing configuration 
</span><span class="cm"> * @return true, signing jar success
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">signJar</span><span class="o">(</span><span class="n">File</span> <span class="n">patchDir</span><span class="o">,</span> <span class="n">BaseVariant</span> <span class="n">variant</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">config</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="na">getBuildType</span><span class="o">().</span><span class="na">getSigningConfig</span><span class="o">()</span>

    <span class="kt">def</span> <span class="n">buildTypeName</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">buildTypeName</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s1">&#39;release&#39;</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="o">}</span>
    
    <span class="kt">def</span> <span class="n">patchFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">patchDir</span><span class="o">,</span> <span class="s2">&#34;patch.jar&#34;</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">patchFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">exec</span> <span class="o">=</span> <span class="n">JavaEnvUtils</span><span class="o">.</span><span class="na">getJdkExecutable</span><span class="o">(</span><span class="s1">&#39;jarsigner&#39;</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="s2">&#34;jarsigner&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">exec</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&#34;Cannot find JAVA_HOME in environment variables&#34;</span><span class="o">)</span>
        <span class="o">}</span>
    
        <span class="kt">def</span> <span class="n">storeFile</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getStoreFile</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">storePassword</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getStorePassword</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">keyAlias</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getKeyAlias</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">keyPassword</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getKeyPassword</span><span class="o">()</span>
        
        <span class="kt">def</span> <span class="n">signPatchFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">patchDir</span><span class="o">,</span> <span class="s2">&#34;patch_signed.jar&#34;</span><span class="o">)</span>
        <span class="n">copyJarFile</span><span class="o">(</span><span class="n">patchFile</span><span class="o">,</span> <span class="n">signPatchFile</span><span class="o">)</span>

        <span class="kt">def</span> <span class="n">command</span> <span class="o">=</span> <span class="s2">&#34;${exec} -tsa http://timestamp.digicert.com -keystore ${storeFile.absolutePath} -storepass ${storePassword} -keypass ${keyPassword} ${signPatchFile.absolutePath} ${keyAlias}&#34;</span>
        <span class="kt">def</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="na">execute</span><span class="o">()</span>
        <span class="n">proc</span><span class="o">.</span><span class="na">waitFor</span><span class="o">()</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">proc</span><span class="o">.</span><span class="na">exitValue</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">println</span> <span class="s2">&#34;Std Out: ${proc.in.text}&#34;</span>
            <span class="n">println</span> <span class="s2">&#34;CommandLine: ${command}&#34;</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">proc</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">println</span><span class="o">(</span><span class="s2">&#34;build signed jar success&#34;</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">println</span><span class="o">(</span><span class="s2">&#34;WARNING: PATCH FILE IS NOT EXISTS!!!&#34;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kt">void</span> <span class="nf">copyJarFile</span><span class="o">(</span><span class="n">File</span> <span class="n">src</span><span class="o">,</span> <span class="n">File</span> <span class="n">dest</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">input</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="na">newDataInputStream</span><span class="o">()</span>
    <span class="kt">def</span> <span class="n">output</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="na">newDataOutputStream</span><span class="o">()</span>
    <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="n">input</span>
    <span class="n">input</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
    <span class="n">output</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
<span class="o">}</span>

</code></pre></div><p>为了安全性, 实际使用中还采用了加密https来下发补丁文件.</p><h3 id="管理逻辑">管理逻辑</h3><p>现在要实现的最优目标是无感知的将bug给修复掉, 当然也可以在接收到新补丁后弹框让用户选择强制重启(万不得以的时候).</p><p>为实现无感知的修复bug避免重启给用户造成的困惑, 实际中会监听App退到后台, 此时如果存在新的补丁的话kill掉进程. 判断应用处于后台我是采用<a href="https://developer.android.com/reference/android/app/Application.ActivityLifecycleCallbacks.html" target="_blank">ActivityLifecycleCallbacks</a> (API level 14), 其他方案也可以参考<a href="https://github.com/wenmingvs/AndroidProcess" target="_blank">AndroidProcess</a>这个项目.</p><p>为了提高补丁的下发概率最好能配合推送服务.</p><blockquote><p>Ps: 以上都不包括RocooFix中实时修复的部分.</p></blockquote><h2 id="tinker">Tinker</h2><p><a href="https://github.com/zzz40500/Tinker_imitator" target="_blank">https://github.com/zzz40500/Tinker_imitator</a></p><div class="article-copyright"><p>文章作者: <a href="https://qbeenslee.com/article/building-an-android-hotfix-architecture/"><i>qbeenslee</i></a></p> <a href="/copyright/"><img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-original="https://qbeenslee.com/img/cc-by-nc-nd.svg" height="20px" width="93px" class="nozoom" alt="CC BY-NC 4.0" title="CC BY-NC 4.0"></a></div></div><div class="related"><h2 class="see-also">关联阅读<ul><li><a href="/article/rxjava-custom-operator-with-bracode-gun/">Rxjava自定义操作符与扫码枪</a></li><li><a href="/article/android-webview-302-redirect/">Android WebView内处理302重定向</a></li><li><a href="/article/about-wandoujia-proguard-config/">豌豆荚Android混淆字典, 眼睛要瞎了</a></li><li><a href="/article/super-simple-android-adapter-pattern/">一种简洁的Adapter模式实现</a></li><li><a href="/article/wemart-android-sdk-analyse/">微猫Android SDK分析</a></li></ul></h2></div></article></div><div id="content-toc-box" class="content-toc-box unselectable" style="height:calc(80% - 60px);right:calc(50% - 720px)"><div class="content-toc" id="content-toc"><div class="wrap"><ul id="content-toc-tree"><li class="toc-node node-h2"> <a class="toc-link" href="#dexposed" title="Dexposed"><span>Dexposed</span></a></li><li class="toc-node node-h2"> <a class="toc-link" href="#andfix" title="Andfix"><span>Andfix</span></a></li><li class="toc-node node-h2"> <a class="toc-link" href="#rocoofix" title="RocooFix"><span>RocooFix</span></a></li><li class="toc-node node-h3"> <a class="toc-link" href="#%e5%ae%89%e5%85%a8%e7%ad%96%e7%95%a5" title="安全策略"><span>安全策略</span></a></li><li class="toc-node node-h3"> <a class="toc-link" href="#%e7%ae%a1%e7%90%86%e9%80%bb%e8%be%91" title="管理逻辑"><span>管理逻辑</span></a></li><li class="toc-node node-h2"> <a class="toc-link" href="#tinker" title="Tinker"><span>Tinker</span></a></li></ul></div></div></div></div><div class="comment-wrap unselectable"><style>#vcomments .info,.at,.vcontent>a[href^="#"],.vcopy,.vlink,.vpower,.vsys{display:none!important}#vcomments{color:var(--text)}.v .vlist .vcard{padding-top:0!important}.v code,.v pre{font-size:100%!important}.vinput{border:none!important}.vheader{border-bottom:1px dashed var(--border-divide)!important}.v[data-class=v] .vwrap{border:1px solid var(--border-divide)!important}</style><section class="section-content unselectable"><div id="vcomments" class="container"></div></section><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",lang:"zh-cn",appId:"G3MMP8E4DNTqvCPV48o7Ph23-gzGzoHsz",appKey:"jYCgILtFpGK1vJUJSE5TtIIs",notify:!1,verify:!1,avatar:"hide",visitor:!1,recordIP:!1,placeholder:"随便说点啥~~"})</script></div></div></div></main><footer class="site_footer_grap unselectable"><div class="has-text-centered"><p>&copy;Qbeenslee 2021</p></div></footer><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css"><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script async type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.js"></script><script async type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script><script async type="text/javascript" src="https://qbeenslee.com/js/scrollspy-6f93da08e6.js"></script><script async type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery-smooth-scroll/2.2.0/jquery.smooth-scroll.min.js"></script><script type="text/javascript" src="https://qbeenslee.com/js/main-7b7a56d043.js"></script><script async type="text/javascript" src="https://hm.baidu.com/hm.js?58b3c65a09f5aacd0e62efe29897c7e4"></script></body></html>